# 时间筛选组件 (TimeFilter) 技术实现文档

## 1. 组件概述
`TimeFilter` 是一个用于 React 应用的高级混合型时间选择器组件。它解决了“快速选择预设时间段”（如最近24小时）与“精确自定义时间范围”之间的交互冲突，将两者融合在一个统一的下拉界面中。

**核心特性：**
*   **统一界面**：日历视图和具体时间输入框始终可见，支持用户在不同模式间无缝切换。
*   **双向联动**：
    *   点击“预设”会自动计算并填充具体的“开始/结束时间”。
    *   手动修改“时间”会自动将状态切换为“自定义”。
*   **范围高亮**：日历视图会直观地高亮显示当前选定时间段内的所有日期。

## 2. 状态管理 (State Management)

组件内部维护了一套局部状态（Local State），只有当用户点击“应用”按钮时，这些状态才会同步给父组件。这种设计避免了频繁的全局重渲染。

```typescript
// 1. UI 交互状态
const [isOpen, setIsOpen] = useState(false); // 下拉菜单开启/关闭

// 2. 数据状态（暂存区）
const [selectedPreset, setSelectedPreset] = useState<TimeRangeOption>(value); // 当前选中的模式（如 '24h', 'custom'）
const [startDate, setStartDate] = useState<string>(customStartDate || ''); // 开始时间 (ISO 格式)
const [endDate, setEndDate] = useState<string>(customEndDate || '');     // 结束时间 (ISO 格式)
```

## 3. 核心逻辑实现

### 3.1 预设驱动时间 (Preset drives Time)
当用户点击左侧侧边栏的预设选项（例如“过去 7 天”）时，组件会立即计算该时间段对应的精确时间戳。

*   **触发动作**：点击侧边栏按钮（如 `'7d'`）。
*   **计算逻辑**：`getRangeFromPreset(preset)` 函数基于当前系统时间 (`new Date()`) 进行推算。
*   **交互效果**：右侧的 `datetime-local` 输入框会被自动填充，同时日历上对应的 7 天会被高亮显示。

### 3.2 时间驱动预设 (Time drives Preset)
任何对右侧精确时间控件（输入框或日历）的手动操作，都会强制将模式切换为“自定义”。

*   **触发动作**：修改输入框的值，或点击日历上的某一天。
*   **逻辑处理**：执行 `setSelectedPreset('custom')`。
*   **交互效果**：左侧侧边栏的选中项跳转至“自定义范围”，明确告知用户当前不再使用标准预设。

### 3.3 可视化日历逻辑
日历部分渲染当前月份的网格视图。

*   **网格渲染**：计算当月天数及首日是周几，动态生成包含前置空白格（Placeholder）的数组。
*   **范围判断 (`isDaySelected`)**：
    不同于普通的单选日历，该组件会判断日期是否落在区间内：
    ```typescript
    // 逻辑简化示意
    targetDate >= startDate && targetDate <= endDate
    ```
    这确保了如果用户选择“本周”，日历上这一周的日期都会显示为蓝色背景。

*   **点击交互 (`handleDayClick`)**：
    点击日历上的某一天（如 15号），组件将其理解为“查看该日全天数据”：
    *   `startDate` -> 当日 00:00:00
    *   `endDate` -> 当日 23:59:59
    *   模式自动切换为 `'custom'`。

## 4. 交互与样式细节
*   **左对齐定位**：下拉菜单采用 `left-0` 绝对定位，防止在左侧工具栏使用时菜单溢出屏幕。
*   **点击外部关闭**：通过 `document.addEventListener('mousedown', ...)` 监听全局点击事件，实现点击组件外部自动收起菜单。
*   **时间格式化**：使用 `toLocalISOString` 函数生成符合 HTML `datetime-local` 标准的格式（`YYYY-MM-DDThh:mm`），去除了秒数以简化用户输入。
